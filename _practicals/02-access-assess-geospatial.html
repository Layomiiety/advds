---
title: "Practical 2"
venue: "Intel Lab, William Gates Building"
abstract: "<p>In this lab session we look at working with geospatial
data, in conjunction with the house prices dataset you created in the
previous practicals.</p>"
author:
- given: Radzim
  family: Sendyka
  url: https://www.cst.cam.ac.uk/people/rs2071
  institute: University of Cambridge
  twitter: 
  gscholar: 
  orcid: 
- given: Christian
  family: Cabrera
  url: https://www.cst.cam.ac.uk/people/chc79
  institute: University of Cambridge
  twitter: 
  gscholar: 
  orcid: 
- given: Carl Henrik
  family: Ek
  url: http://carlhenrik.com
  institute: University of Cambridge
  twitter: 
  gscholar: 
  orcid: 
- given: Neil D.
  family: Lawrence
  url: http://inverseprobability.com
  institute: University of Cambridge
  twitter: 
  gscholar: 
  orcid: 
edit_url: https://github.com/mlatcl/advds/edit/gh-pages/_lamd/access-assess-geospatial.md
date: 2024-11-07
published: 2024-11-07
time: "15:00"
featured_image: assets/images/practical-two.png
transition: None
ipynb: 02-access-assess-geospatial.ipynb
layout: practical
categories:
- notes
---



<!-- Do not edit this file locally. -->
<!---->
<!-- Do not edit this file locally. -->
<!-- Do not edit this file locally. -->
<!-- The last names to be defined. Should be defined entirely in terms of macros from above-->
<!--

-->
<p><strong>The check Session for this Practical is 12th November
2024.</strong> Prerequisite: practical 1, and a working database with
tables price paid data (i.e., <code>pp_data</code>) and postcodes(i.e.,
<code>postcode_data</code>)</p>
<p>In this lab session we look at working with geospacial data, in
conjunction with the house prices dataset you created in the previous
practicals. The goal is to enrich the data from the first practical with
geographic data enabling better informed data analysis. Access to the
price paid database is needed to complete some of the below exercises.
You are asked to write reusable code that will help you in the
assessment.</p>
<h2 id="accessing-open-street-maps">Accessing Open Street Maps</h2>
<div style="text-align:right">
<span class="editsection-bracket" style="">[</span><span
class="editsection"
style=""><a href="https://github.com/lawrennd/snippets/edit/main/_datasets/includes/accessing-osm.md" target="_blank" onclick="ga('send', 'event', 'Edit Page', 'Edit', 'https://github.com/lawrennd/snippets/edit/main/_datasets/includes/accessing-osm.md', 13);">edit</a></span><span class="editsection-bracket" style="">]</span>
</div>
<p><a href="https://www.openstreetmap.org/#map=6/54.91/-3.43">Open
Street Maps (OSM)</a> is an open geographic database that can provide
useful information about different locations and places in the planet.
In this example, we will download data about the city of Kampala,
Uganda. As always, we should start by installing some Python
packages.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install osmnx</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip uninstall <span class="op">--</span>yes matplotlib</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install matplotlib<span class="op">==</span><span class="fl">3.7.1</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx <span class="im">as</span> ox</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>, module<span class="op">=</span><span class="st">&#39;osmnx&#39;</span>)</span></code></pre></div>
<p>We will download data of Kamplala, Uganda, which has the following
latitude and longitude.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>place_name <span class="op">=</span> <span class="st">&quot;Kampala, Uganda&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">0.347596</span> <span class="co"># Kampala latitude</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">32.582520</span> <span class="co"># Kampala longitude</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>placestub <span class="op">=</span> place_name.lower().replace(<span class="st">&#39; &#39;</span>, <span class="st">&#39;-&#39;</span>).replace(<span class="st">&#39;,&#39;</span>,<span class="st">&#39;&#39;</span>)</span></code></pre></div>
<p>We’ll create a bounding box which is 0.02 degrees wide, 1 degree is
around 111km (<a
href="https://en.wikipedia.org/wiki/Metre">circumference of the Earth is
around 40,000 km</a> and 40,000/360=111km). Note: will this
approximation work well in all countries?</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>box_width <span class="op">=</span> <span class="fl">0.02</span> <span class="co"># About 2.2 km</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>box_height <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>north <span class="op">=</span> latitude <span class="op">+</span> box_height<span class="op">/</span><span class="dv">2</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>south <span class="op">=</span> latitude <span class="op">-</span> box_width<span class="op">/</span><span class="dv">2</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>west <span class="op">=</span> longitude <span class="op">-</span> box_width<span class="op">/</span><span class="dv">2</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>east <span class="op">=</span> longitude <span class="op">+</span> box_width<span class="op">/</span><span class="dv">2</span></span></code></pre></div>
<p>Now we’ll download a set of points of interest from OpenStreetMap. We
can specify the points of interest we’re interested in by building a
small dictionary containing their labels as follows. A Point of Interest
is a location with certain importance in the geographic area. They can
vary from amenities to touristic places as you can see in the
following.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve POIs</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>tags <span class="op">=</span> {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;amenity&quot;</span>: <span class="va">True</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;buildings&quot;</span>: <span class="va">True</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;historic&quot;</span>: <span class="va">True</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;leisure&quot;</span>: <span class="va">True</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;shop&quot;</span>: <span class="va">True</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;tourism&quot;</span>: <span class="va">True</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;religion&quot;</span>: <span class="va">True</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;memorial&quot;</span>: <span class="va">True</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We can use <code>osmnx</code> to download all such points of interest
within a given bounding box.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>pois <span class="op">=</span> ox.geometries_from_bbox(north, south, east, west, tags)</span></code></pre></div>
<p>That operation can take some time, particularly as the bounding box
grows larger. Once it is complete we can check how many points of
interest we have found.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;There are </span><span class="sc">{number}</span><span class="st"> points of interest surrounding </span><span class="sc">{placename}</span><span class="st"> latitude: </span><span class="sc">{latitude}</span><span class="st">, longitude: </span><span class="sc">{longitude}</span><span class="st">&quot;</span>.<span class="bu">format</span>(number<span class="op">=</span><span class="bu">len</span>(pois), placename<span class="op">=</span>place_name, latitude<span class="op">=</span>latitude, longitude<span class="op">=</span>longitude))</span></code></pre></div>
<p>And then we can examine their contents in more detail.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pois</span></code></pre></div>
<h3 id="we-notice-a-few-things">We notice a few things:</h3>
<ol type="1">
<li><p>Points of interest do not have a consistent OpenStreetMap
<code>element_type</code>, some are <code>node</code>, others are
<code>relation</code> and we also have <code>way</code>. You can find
out more about elements in OpenStreetMap on <a
href="https://wiki.openstreetmap.org/wiki/Elements">this wiki page</a>.
This will become important when tidying up the data for next stage
processing.</p></li>
<li><p>Many of the values are missing. In SQL we would express a missing
value as <code>NULL</code>. But in <code>pandas</code> a missing value
is expressed as not-a-number, <code>NaN</code>. This is quite a common
standard, but it is not the only standard. Sometimes data is collected
and coded with an “unreasonable” value for a missing value. For example,
someone might set missing values for heights to -999. The concept is
that this is an obviously void “height” and would trigger a human user
to check whether it’s a missing value. Of course, this is obvious to
humans, but not necessarily to a computer!</p></li>
</ol>
<p>Nodes, ways and relations in OpenStreetMap all have different
<em>keys</em> associated with them. The data is not structured in
standard database columns. Different points of interest might have
different keys present or absent. We might be interested in the
following keys.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>keys <span class="op">=</span> [<span class="st">&quot;name&quot;</span>,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;addr:city&quot;</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;addr:postcode&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;amenity&quot;</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;building&quot;</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;building:name&quot;</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;building:colour&quot;</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;building:material&quot;</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;historic&quot;</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;memorial&quot;</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;religion&quot;</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;tourism&quot;</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;emergency&quot;</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;leisure&quot;</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;shop&quot;</span>]</span></code></pre></div>
<p>But our downloaded <code>gdf</code> may have fewer keys.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pois.columns.values</span></code></pre></div>
<p>We can write a short piece of code to discover which keys are missing
drom the data frame’s columns.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> keys:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> pois.columns:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(key)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>present_keys <span class="op">=</span> [key <span class="cf">for</span> key <span class="kw">in</span> keys <span class="cf">if</span> key <span class="kw">in</span> pois.columns]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>pois[present_keys]</span></code></pre></div>
<p>This gives us the relevant points of interest (part of the map). If
we’d like to see the entire street network, we can download the entire
graph from the location.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> ox.graph_from_bbox(north, south, east, west)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve nodes and edges</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>nodes, edges <span class="op">=</span> ox.graph_to_gdfs(graph)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get place boundary related to the place name as a geodataframe</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>area <span class="op">=</span> ox.geocode_to_gdf(place_name)</span></code></pre></div>
<p>Which we can then render as follows.</p>
<p>We have the POI information on all tourist places structured in a
geodataframe. To work with them in a machine learning algorithm, it will
be easier to convert them to a pandas DataFrame.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pois_df <span class="op">=</span> pd.DataFrame(pois)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>pois_df[<span class="st">&#39;latitude&#39;</span>] <span class="op">=</span> pois_df.<span class="bu">apply</span>(<span class="kw">lambda</span> row: row.geometry.centroid.y, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>pois_df[<span class="st">&#39;longitude&#39;</span>] <span class="op">=</span> pois_df.<span class="bu">apply</span>(<span class="kw">lambda</span> row: row.geometry.centroid.x, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>tourist_places_df <span class="op">=</span> pois_df[pois_df.tourism.notnull()]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(tourist_places_df))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>tourist_places_df</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>poi_counts <span class="op">=</span> {}</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>poi_types <span class="op">=</span>[<span class="st">&quot;amenity&quot;</span>, <span class="st">&quot;historic&quot;</span>, <span class="st">&quot;leisure&quot;</span>, <span class="st">&quot;shop&quot;</span>, <span class="st">&quot;tourism&quot;</span>, <span class="st">&quot;religion&quot;</span>, <span class="st">&quot;memorial&quot;</span>]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tag <span class="kw">in</span> poi_types:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> tag <span class="kw">in</span> pois_df.columns:</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    poi_counts[tag] <span class="op">=</span> pois_df[tag].notnull().<span class="bu">sum</span>()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    poi_counts[tag] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>poi_counts_df <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(poi_counts.items()), columns<span class="op">=</span>[<span class="st">&#39;POI Type&#39;</span>, <span class="st">&#39;Count&#39;</span>])</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>poi_counts_df</span></code></pre></div>
<h2 id="assessing-the-available-openstreetmap-features">Assessing the
Available OpenStreetMap Features</h2>
<div style="text-align:right">
<span class="editsection-bracket" style="">[</span><span
class="editsection"
style=""><a href="https://github.com/lawrennd/snippets/edit/main/_datasets/includes/assessing-osm.md" target="_blank" onclick="ga('send', 'event', 'Edit Page', 'Edit', 'https://github.com/lawrennd/snippets/edit/main/_datasets/includes/assessing-osm.md', 13);">edit</a></span><span class="editsection-bracket" style="">]</span>
</div>
<p>In the course assessment you will be given the task of constructing a
prediction system for various indicators at a given location. We expect
that knowledge of the local region around the property should be helpful
in making those predictions. To evaluate this we will now look at <a
href="https://www.openstreetmap.org">OpenStreetMap</a> as a data
source.</p>
<p>In this section, you should follow the methodology used in the above
example to extract summary OSM information that can be useful in making
predictions about an area. Use code from the example to construct a
function that summarises the number of various points of interest in a
target area. You should write reusable code that allows you to explore
the characteristics of different points of interest.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_pois_near_coordinates(latitude: <span class="bu">float</span>, longitude: <span class="bu">float</span>, tags: <span class="bu">dict</span>, distance_km: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Count Points of Interest (POIs) near a given pair of coordinates within a specified distance.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">        latitude (float): Latitude of the location.</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">        longitude (float): Longitude of the location.</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">        tags (dict): A dictionary of OSM tags to filter the POIs (e.g., {&#39;amenity&#39;: True, &#39;tourism&#39;: True}).</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">        distance_km (float): The distance around the location in kilometers. Default is 1 km.</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: A dictionary where keys are the OSM tags and values are the counts of POIs for each tag.</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span></code></pre></div>
<p>Now that you have written reusable code, choose the tags you want to
query. This should be different from the tags used in the example. You
can also search for specific tags like this:
<code>"amenity": ["university", ...</code>.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify this dict</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>tags <span class="op">=</span> {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;amenity&quot;</span>: [<span class="st">&quot;university&quot;</span>],</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;historic&quot;</span>: <span class="va">True</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;leisure&quot;</span>: <span class="va">True</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;shop&quot;</span>: <span class="va">True</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;tourism&quot;</span>: <span class="va">True</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;religion&quot;</span>: <span class="va">True</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here there are 13 UK locations.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>locations_dict <span class="op">=</span> {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Cambridge&quot;</span>: (<span class="fl">52.2054</span>, <span class="fl">0.1132</span>),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Oxford&quot;</span>: (<span class="fl">51.7570</span>, <span class="op">-</span><span class="fl">1.2545</span>),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Euston Square&quot;</span>: (<span class="fl">51.5246</span>, <span class="op">-</span><span class="fl">0.1340</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Temple&quot;</span>: (<span class="fl">51.5115</span>, <span class="op">-</span><span class="fl">0.1160</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Kensington&quot;</span>: (<span class="fl">51.4988</span>, <span class="op">-</span><span class="fl">0.1749</span>),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Barnsley&quot;</span>: (<span class="fl">53.5526</span>, <span class="op">-</span><span class="fl">1.4797</span>),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Mansfield&quot;</span>: (<span class="fl">53.1472</span>, <span class="op">-</span><span class="fl">1.1987</span>),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Wakefield&quot;</span>: (<span class="fl">53.6848</span>, <span class="op">-</span><span class="fl">1.5039</span>),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Sunderland&quot;</span>: (<span class="fl">54.9069</span>, <span class="op">-</span><span class="fl">1.3838</span>),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Rotherham&quot;</span>: (<span class="fl">53.4300</span>, <span class="op">-</span><span class="fl">1.3568</span>),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Doncaster&quot;</span>: (<span class="fl">53.5228</span>, <span class="op">-</span><span class="fl">1.1288</span>),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Chesterfield&quot;</span>: (<span class="fl">53.2350</span>, <span class="op">-</span><span class="fl">1.4210</span>),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Huddersfield&quot;</span>: (<span class="fl">53.6450</span>, <span class="op">-</span><span class="fl">1.7794</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<h3 id="exercise-1">Exercise 1</h3>
<p>Use your code to query the OSM feature counts for each of them, and
combine them into one dataframe.</p>
<h3 id="exercise-2">Exercise 2</h3>
<p>Use k-means clustering or another clustering method to try to find
clusters of similar areas, based on nearby OSM features.</p>
<h3 id="exercise-3">Exercise 3</h3>
<p>Investigate the locations yourself, and assign them categories based
on your interpretation. Visualise and compare your manual assignments
against your clustering results.</p>
<h3 id="exercise-4">Exercise 4</h3>
<p>Normalise your dataframe and compute a distance matrix for the
locations. Visualise it, and compare the outcode with your previous
clustering results.</p>
<h3 id="exercise-5">Exercise 5</h3>
<p>Which features you included were correlated among each other?
Investigate and plot a feature correlation matrix. What do these results
say about your feature selection?</p>
<h2 id="joining-spatial-data">Joining Spatial Data</h2>
<div style="text-align:right">
<span class="editsection-bracket" style="">[</span><span
class="editsection"
style=""><a href="https://github.com/lawrennd/snippets/edit/main/_access/includes/spatial-join.md" target="_blank" onclick="ga('send', 'event', 'Edit Page', 'Edit', 'https://github.com/lawrennd/snippets/edit/main/_access/includes/spatial-join.md', 13);">edit</a></span><span class="editsection-bracket" style="">]</span>
</div>
<h3 id="matching-openstreetmap-and-house-prices-data">Matching
OpenStreetMap and House Prices data</h3>
<p>In this exercise you will download the geographies of houses from
OpenStreetMap and map them to visualise the records you see in the house
price dataset. This is a data linking and validation exercise.</p>
<p>The latitude and longitude of Cambridge are as follows:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>place_name <span class="op">=</span> <span class="st">&quot;Cambridge&quot;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">52.1951</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">0.1313</span></span></code></pre></div>
<p>We want to execute an SQL query on your database to select all houses
in a 1km x 1km region around the centre of Cambridge that have been part
of housing transactions since 2020.</p>
<p>This operation can take a very long time. This is because the table
is not indexed on coordinate data, and therefore the query has to check
tens of millions of rows. This can be fixed by constructing an index on
the <code>latitude</code> and <code>longitude</code> values, using
<code>BTREE</code> to make a joint index. <em>Note that indexing can
take a long time.</em> Consider also indexing your table by other
variables you might find useful later.</p>
<h3 id="exercise-6">Exercise 6</h3>
<p>Index the table on the coordinate data using a <code>BTREE</code> and
index other columns you might find useful.</p>
<h3 id="exercise-7">Exercise 7</h3>
<p>Write an SQL query on your database to select all houses in a 1km x
1km region around the centre of Cambridge that have been part of housing
transactions since 2020.</p>
<h3 id="exercise-8">Exercise 8</h3>
<p>Get information about all the buildings in that area from
OpenStreetMaps (<code>'building': True</code>). You will need their
address information (<code>addr:housenumber</code>,
<code>addr:street</code>, <code>addr:postcode</code>, …) and geometry
polygon (<code>geometries_from_bbox</code>). Construct a dataframe that
lists all OSM buildings in the area that have a full address, along with
their area (in square meters). Plot a map of the area, using color to
mark the buildings with addresses and the ones without.</p>
<h3 id="exercise-9">Exercise 9</h3>
<p>Match the houses you found in the price paid dataset with the
buildings on OpenStreetMaps based on their addresses. Can this be
applied to all building types? Are there any PP transactions which you
couldn’t match to an OSM building, or any OSM buildings you coulnd’t
match to a PP transaction? If so, what could be the reason for this? Do
you employ any techniques to find non-exact matches? If yes, what
matches would you have missed without it? Are you encountering false
positive matches? Use this address matching to merge the two
dataframes.</p>
<h3 id="exercise-10">Exercise 10</h3>
<p>Examine the relationship between the price and area of a property. -
What other variables do you need to account for? - Is the correlation as
strong as you would expect? - What factors could be impacting this?</p>
<p>Visualise the relationships you found.</p>
<p>Demonstrate the reusability of your code by executing the same
analysis for Oxford.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>place_name <span class="op">=</span> <span class="st">&quot;Oxford&quot;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">51.7520</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>longitude <span class="op">=</span> <span class="op">-</span><span class="fl">1.2577</span></span></code></pre></div>
<h3 id="exercise-11">Exercise 11</h3>
<p>Replicating the same analysis for Oxford. You do not need to answer
all the questions again, but you should show that your code works for
this new input without the need to modify it. You should use the Fynesse
library for this. Finish by plotting a map of the area and the
correlation you find.</p>
<h2 id="conclusions">Conclusions</h2>
<p>You should find some of the code you wrote above useful in your final
assessment. Make sure you wrote the code to be reusable and efficient,
and do include it in your Fynesse library. The functions you are
particularly likely to reuse are the OSM feature search, and map
visualisation functions.</p>
<h3 id="exercise-12">Exercise 12</h3>
<p>Add relevant code to your Fynesse library. Demonstrate this was
successful by installing your library below and calling at least two
example functions.</p>
<h2 id="thanks">Thanks!</h2>
<p>For more information on these subjects and more you might want to
check the following resources.</p>
<ul>
<li>book: <a
href="https://www.penguin.co.uk/books/455130/the-atomic-human-by-lawrence-neil-d/9780241625248">The
Atomic Human</a></li>
<li>twitter: <a href="https://twitter.com/lawrennd">@lawrennd</a></li>
<li>podcast: <a href="http://thetalkingmachines.com">The Talking
Machines</a></li>
<li>newspaper: <a
href="http://www.theguardian.com/profile/neil-lawrence">Guardian Profile
Page</a></li>
<li>blog: <a
href="http://inverseprobability.com/blog.html">http://inverseprobability.com</a></li>
</ul>
<h1 id="references">References</h1>

